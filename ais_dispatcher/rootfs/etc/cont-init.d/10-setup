#!/command/with-contenv bashio
set -euo pipefail

bashio::log.info "Preparing AIS Dispatcher data directory"

mkdir -p /data/ais

if ! bashio::fs.file_exists "/data/ais/.installed"; then
    bashio::log.info "Initial install detected; seeding vendor package"
    cp -a /usr/share/aisdispatcher/. /data/ais/
    touch /data/ais/.installed
    bashio::log.info "Seeded vendor package into /data/ais"
else
    bashio::log.info "Existing install detected; refreshing vendor binaries"
    for dir in bin lib htdocs update_cache; do
        bashio::log.info "Refreshing directory: ${dir}"
        rm -rf "/data/ais/${dir}"
        cp -a "/usr/share/aisdispatcher/${dir}" /data/ais/
    done
    for template in aiscontrol.cfg aisdispatcher.json; do
        if ! bashio::fs.file_exists "/data/ais/etc/${template}"; then
            bashio::log.info "Creating missing template: ${template}"
            cp -a "/usr/share/aisdispatcher/etc/${template}" "/data/ais/etc/${template}"
        fi
    done
fi

if [ -d "/home/ais" ] && [ ! -L "/home/ais" ]; then
    bashio::log.info "Removing stale /home/ais directory"
    rm -rf /home/ais
fi
ln -sfn /data/ais /home/ais
bashio::log.info "Symlinked /home/ais to persistent data"

bashio::log.info "Linking architecture-specific binaries"
if /bin/bash /home/ais/bin/link_binary >/tmp/link_binary.log 2>&1; then
    bashio::log.info "Binary link script completed successfully"
else
    status="$?"
    bashio::log.warning "Binary link script exited with status ${status}"
    bashio::log.warning "Output: $(cat /tmp/link_binary.log)"
fi
rm -f /tmp/link_binary.log

bashio::log.info "Setting ownership on /data/ais"
chown -R ais:ais /data/ais
bashio::log.info "Initialization script completed"
